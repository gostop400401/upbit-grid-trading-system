# 제품 요구사항 정의서 (Product Requirement Document)

## 1. 개요 (Overview)
*   **프로젝트명**: Upbit Grid Trading System (업비트 그리드매매 시스템)
*   **목적**: 오라클 클라우드 환경에서 안정적으로 동작하는 업비트(Upbit) 기반 USDT 그리드 매매 자동화 시스템을 구축하고, 디스코드(Discord) 및 터미널을 통해 실시간 제어 및 모니터링 환경을 제공함.
*   **핵심 가치**: 
    *   **자동화**: 오라클 클라우드 상에서 24시간 중단 없는 자동 매매 수행.
    *   **접근성**: 디스코드 챗봇을 통해 어디서든 손쉽게 상태 확인 및 제어 가능.
    *   **안정성**: 사용자 실수 방지를 위한 입력 검증 및 자산 보호(위기 관리) 로직 포함.

## 2. 시스템 아키텍처 (System Architecture)
*   **실행 환경 (Server)**: 오라클 클라우드 (Oracle Cloud)
*   **거래소 (Exchange)**: 업비트 (Upbit) API
*   **인터페이스 (Interface)**:
    *   **디스코드 (Discord)**: 주 사용 채널. 명령 전달(!시작, !종료 등), 상태 알림, 설정 입력.
    *   **터미널 (Terminal)**: 개발자 디버깅, 상세 로그 확인, 비상 제어.
*   **데이터베이스 (Database)**: 설정값(Trading Config), 계약 정보(Open Orders), 거래 내역(Trade History)들의 영구 저장.

## 3. 주요 기능 요구사항 (Functional Requirements)

### 3.1 시스템 시작 및 설정 (Initialization & Configuration)
*   **시작 명령**: 사용자가 디스코드에서 `!시작` 명령어 입력 시 설정 프로세스 진입.
*   **대화형 설정 (Interactive Setup)**:
    *   시스템은 순차적으로 설정값을 질문하고 사용자가 답변하는 형태.
    *   **입력 항목**:
        1.  거래 대상 코인 선택 (기본: USDT, 그 외 KRW 마켓 코인 등 선택 가능)
        2.  거래 가격 범위 (예: 1400 ~ 1500)
        3.  총 그리드 수 (최대 계약 수)
        4.  그리드 간격 (예: 10원)
        5.  그리드당 매매 수량/금액 (예: 5 USDT)
        6.  익절 가격 간격 (예: 3원 또는 N%)
*   **설정 저장**: 자주 사용하는 설정 프리셋 저장 및 불러오기 기능 지원.
*   **유효성 검사 (Validation)**:
    *   입력된 설정값 기반 필요 자산 계산.
    *   사용자 계정의 실제 '거래 가능 잔액' 조회 및 비교.
    *   **잔액 부족 시**: 경고 메시지 출력 및 실행 불가 알림.
    *   **잔액 충족 시**: 승인 요청 메세지 출력 -> 사용자 승인 시 자동 매매 시작.

### 3.2 자동 매매 로직 (Grid Trading Logic)
*   **초기 그리드 설정 (Initial Grid Setup)**:
    *   시스템 시작 시, 설정된 가격 범위와 그리드 수에 맞춰 매수 지점(Grid Lines) 계산.
    *   현재가 아래에 위치한 모든 그리드 지점에 **지정가 매수 주문(Limit Buy Order)** 일괄 배치.
    *   (옵션) 상방 그리드에 이미 보유한 코인이 있다면 매도 주문 배치 가능하나, 기본적으로는 USDT로 시작하여 하방 매수 대기.

*   **주문 체결 처리 (Order Execution Handling)**:
    *   **매수 체결 시 (Buy Filled)**:
        1.  체결된 주문 정보를 바탕으로 DB에 새로운 **계약(Contract)** 생성 (상태: Active).
        2.  해당 계약의 **매도 목표가** (매수 체결가 + 익절 간격) 계산.
        3.  즉시 업비트에 **지정가 매도 주문(Limit Sell Order)** 배치.
        4.  디스코드에 매수 체결 알림 전송 (체결가, 수량, 목표가 포함).
    *   **매도 체결 시 (Sell Filled)**:
        1.  해당 계약의 상태를 **종료(Closed)**로 업데이트 및 실현 손익 DB 기록.
        2.  해당 그리드 줄이 비게 되므로, 동일한 가격(원래 매수가)에 다시 **지정가 매수 주문(Limit Buy Order)** 재배치 (재진입 로직).
        3.  디스코드에 매도 체결(익절) 알림 전송 (수익금, 수익률 포함).

*   **실시간 감시 (Real-time Monitoring)**:
    *   Websocket 또는 주기적 REST API 조회(Polling)를 통해 주문 상태(체결 여부) 실시간 확인.
    *   특히 '매수 완료 -> 매도 주문' 및 '매도 완료 -> 재매수 주문' 사이의 딜레이를 최소화해야 함.

*   **범위 이탈 처리 (Out of Range Handling)**:
    *   **하방 이탈 (Price < Min Range)**: 최저점 매수 체결 후 더 하락하면 추가 매수 없이 대기 (존버). 사용자에게 경고 알림.
    *   **상방 이탈 (Price > Max Range)**: 보유 계약 모두 매도 청산 후 가격 상승 시 추가 매수 없이 대기 (시스템은 가동 상태 유지). 보유 현금 100% 상태가 됨.

### 3.3 모니터링 및 알림 (Monitoring & Notification)
*   **실시간 알림**:
    *   매수/매도 체결 즉시 디스코드 메시지 전송.
    *   시스템 시작/종료/오류 발생 시 상태 메시지 전송.
*   **상태 조회**: 현재 보유 포지션, 미실현 손익, 최근 거래 내역 등을 명령어 등을 통해 조회 가능.

#### 3.3.1 Discord 명령어 체계 (Discord Commands)

##### **기본 제어 명령어 (Core Control Commands)**
| 명령어 | 기능 | 우선순위 |
|--------|------|----------|
| `!시작` | 그리드 트레이딩 설정 시작 (대화형 설정) | 필수 |
| `!종료` | 트레이딩 시스템 완전 종료 | 필수 |
| `!일시정지` | 새로운 주문 중지 (기존 주문 유지) | 권장 |
| `!재개` | 일시정지된 시스템 재개 | 권장 |

##### **모니터링 명령어 (Monitoring Commands)**
| 명령어 | 기능 | 출력 정보 | 우선순위 |
|--------|------|-----------|----------|
| `!상태` | 현재 시스템 상태 조회 | - 실행 상태 (실행중/정지)<br>- 활성 계약 수<br>- 미체결 매수 주문 수<br>- 총 실현 손익 | **필수** |
| `!포지션` | 활성 계약 상세 조회 | - 각 계약의 진입가<br>- 목표가<br>- 수량<br>- 미실현 손익<br>- 체결 시간 | **필수** |
| `!주문` | 미체결 주문 현황 | - 매수 주문 목록 (가격별)<br>- 매도 주문 목록<br>- 주문 상태 | 권장 |
| `!수익` | 거래 통계 조회 | - 총 실현 손익<br>- 총 거래 횟수<br>- 평균 수익률<br>- 최고/최저 수익 거래 | **필수** |
| `!그리드` | 현재 그리드 상태 조회 | - 가격 범위<br>- 그리드 간격<br>- 빈 그리드 / 활성 그리드<br>- 현재 시장가 | 권장 |

##### **분석 및 리포트 명령어 (Analytics Commands)**
| 명령어 | 기능 | 출력 정보 | 우선순위 |
|--------|------|-----------|----------|
| `!거래내역` [N] | 최근 N개 거래 내역 조회 (기본 10개) | - 거래 시간<br>- 매수가 / 매도가<br>- 수량<br>- 손익 | 권장 |
| `!일일통계` | 오늘 거래 요약 | - 오늘 거래 횟수<br>- 오늘 실현 손익<br>- 평균 보유 시간 | 선택 |
| `!잔고` | 현재 계정 잔고 조회 | - KRW 잔고<br>- USDT 잔고<br>- 총 평가액 | **필수** |

##### **위험 관리 명령어 (Risk Management Commands)**
| 명령어 | 기능 | 확인 절차 | 우선순위 |
|--------|------|-----------|----------|
| `!긴급청산` | 모든 포지션 즉시 청산 | - 경고 메시지<br>- 예상 손익 표시<br>- 'YES' 재확인 필수 | **필수** |
| `!주문취소` [가격] | 특정 가격의 미체결 주문 취소 | - 주문 정보 확인<br>- 취소 확인 | 권장 |
| `!전체주문취소` | 모든 미체결 주문 취소 | - 전체 주문 목록 표시<br>- 'YES' 재확인 필수 | 선택 |

##### **설정 및 정보 명령어 (Configuration & Info Commands)**
| 명령어 | 기능 | 출력 정보 | 우선순위 |
|--------|------|-----------|----------|
| `!설정보기` | 현재 그리드 설정 조회 | - 코인 티커<br>- 가격 범위<br>- 그리드 간격/개수<br>- 주문 수량<br>- 익절 간격 | 권장 |
| `!도움말` | 사용 가능한 명령어 목록 | - 전체 명령어 목록<br>- 각 명령어 설명 | **필수** |
| `!서버상태` | 서버 리소스 상태 | - CPU/메모리 사용률<br>- 업타임<br>- API 응답 시간 | 선택 |

##### **명령어 설계 원칙**
1. **직관성**: 한글 명령어 사용으로 접근성 향상
2. **안전성**: 위험한 작업은 2단계 확인 절차 필수
3. **정보성**: 실행 결과를 명확하고 상세하게 표시
4. **일관성**: 비슷한 기능은 비슷한 명령어 패턴 사용
5. **확장성**: 향후 추가 기능을 위한 명령어 네이밍 체계 유지

##### **우선순위별 개발 순서**
1. **Phase 1 (필수)**: `!시작`, `!종료`, `!상태`, `!포지션`, `!수익`, `!잔고`, `!긴급청산`, `!도움말`
2. **Phase 2 (권장)**: `!일시정지`, `!재개`, `!주문`, `!그리드`, `!거래내역`, `!설정보기`, `!주문취소`
3. **Phase 3 (선택)**: `!일일통계`, `!전체주문취소`, `!서버상태`


### 3.4 시스템 제어 및 관리 (Control & Management)
*   **설정 변경**:
    *   시스템 실행 중에는 설정 변경 불가.
    *   '중지' 요청 -> 시스템 일시 정지 -> 설정값 수정 -> '재시작' 흐름으로 변경 가능.
*   **종료**:
    *   `!종료` 명령어로 프로그램 완전 종료 요청.
    *   종료 시 오라클 클라우드 상의 프로세스 정리 및 안전한 종료.

### 3.5 위기 관리 (Risk Management)
*   **긴급 청산 (Panic Sell)**:
    *   급격한 시세 하락 등 위기 상황 시 포지션 일괄 청산 요청 기능.
    *   청산 후 결과 리포트(손익 등) 출력 및 시스템 종료 대기.

### 3.6 기술적 제약 및 예외 처리 (Technical Constraints & Exception Handling)
*   **API Rate Limit**: 업비트 API 요청 제한(초당/분당 요청 수)을 준수하는 로직 구현 (Throttle/Queue 사용).
*   **네트워크 오류 복구**: 일시적인 네트워크 단절 시 자동 재시도(Retry) 및 심각한 오류 시 관리자 알림.
*   **프로세스 복구 (Process Recovery & State Reconciliation)**:
    *   **누락 주문 복구**: 시스템 시작 시 DB의 'Active 계약'을 로드하여 업비트의 '미체결 주문'과 대조. 만약 매도 주문이 없는 Active 계약 발견 시, 즉시 해당 목표가로 **매도 주문 재전송**.
    *   **상태 동기화**: 서버 재시작 시 DB 상태를 기준으로 메모리 상의 객체(Trading Context)를 완벽히 복원하여 중단 없는 매매 수행.

### 3.7 보안 요구사항 (Security Requirements)
*   **사용자 인증**: 디스코드 봇은 지정된 Admin User ID(환경변수로 설정)의 명령어만 수행하여 타인의 조작 방지.
*   **민감 정보 관리**: API Access/Secret Key는 소스코드가 아닌 환경변수(.env) 파일로 분리하여 관리.

## 4. 데이터 요구사항 (Data Requirements)
*   **설정 정보**: 코인명, 가격 범위, 그리드 설정값 등 최근 설정 유지.
*   **주문/계약 정보**:
    *   Active Contracts (체결되었으나 아직 매도되지 않은 계약)
    *   Contract ID, 진입가, 수량, 목표가, 생성시간 등.
*   **거래 이력**: 완료된 거래(Trading History)와 실현 손익 기록.

## 5. UI/UX 요구사항 (User Interface)
*   **Discord Interface**:
    *   명령어 기반의 깔끔한 텍스트 UI.
    *   중요 정보(체결, 경고 등)는 시인성 좋은 포맷(Embed 등) 활용.
    *   사용자 입력 실수 최소화를 위한 단계별 질문/답변 방식.

## 7. 권장 기술 스택 (Recommended Tech Stack)
*   **Language**: Python 3.9+ (안정성 및 라이브러리 호환성)
*   **Library**:
    *   `pyupbit` (업비트 전용 래퍼) 또는 `ccxt` (확장성 고려)
    *   `discord.py` 또는 `pycord` (비동기 처리 최적화)
*   **Database**: SQLite (파일 기반, 배포/백업 용이성)
*   **Async**: `asyncio` 기반의 비동기 아키텍처 (실시간성 확보)

## 6. 참고 자료 (References)
*   `참고자료\dev_log`
*   `참고자료\funding-fee-bot`
*   `참고자료\Plan`
